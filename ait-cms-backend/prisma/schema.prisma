// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============ ENUMS ============

enum Role {
  STUDENT
  TEACHER
  ADMIN
  ORGANIZER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum NotificationType {
  EVENT
  ATTENDANCE
  GRIEVANCE
  MAINTENANCE
  ANNOUNCEMENT
  SYSTEM
}

// ============ USERS & AUTHENTICATION ============

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  phone        String?
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Role assignments (many-to-many)
  roles UserRole[]

  // Profile links (1:1)
  studentProfile   Student?
  teacherProfile   Teacher?
  adminProfile     Admin?
  organizerProfile Organizer?

  // Relations
  refreshTokens       RefreshToken[]
  notifications       Notification[]
  grievancesSubmitted Grievance[]          @relation("SubmittedGrievances")
  maintenanceRequests MaintenanceRequest[]
  eventRegistrations  EventRegistration[]

  @@map("users")
}

model UserRole {
  id     String @id @default(uuid())
  userId String @map("user_id")
  role   Role

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_roles")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ============ ROLE PROFILES ============

model Student {
  id             String @id @default(uuid())
  userId         String @unique @map("user_id")
  rollNumber     String @unique @map("roll_number")
  enrollmentYear Int    @map("enrollment_year")

  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  classId String @map("class_id")
  class   Class  @relation(fields: [classId], references: [id])

  attendanceRecords Attendance[]

  @@map("students")
}

model Teacher {
  id           String @id @default(uuid())
  userId       String @unique @map("user_id")
  employeeId   String @unique @map("employee_id")
  departmentId String @map("department_id")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id])

  timetableSlots   TimetableSlot[]
  uploadedFiles    File[]
  attendanceMarked Attendance[]

  @@map("teachers")
}

model Admin {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  grievancesHandled Grievance[] @relation("HandledGrievances")

  @@map("admins")
}

model Organizer {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  events Event[]

  @@map("organizers")
}

// ============ ACADEMIC STRUCTURE ============

model Department {
  id   String @id @default(uuid())
  name String @unique
  code String @unique

  teachers Teacher[]
  subjects Subject[]
  classes  Class[]

  @@map("departments")
}

model Class {
  id           String @id @default(uuid())
  name         String // e.g., "CSE-3A"
  year         Int // 1, 2, 3, 4
  section      String // A, B, C
  departmentId String @map("department_id")

  department     Department      @relation(fields: [departmentId], references: [id])
  students       Student[]
  timetableSlots TimetableSlot[]

  @@unique([departmentId, year, section])
  @@map("classes")
}

model Subject {
  id           String @id @default(uuid())
  name         String
  code         String @unique
  departmentId String @map("department_id")
  credits      Int    @default(3)

  department     Department      @relation(fields: [departmentId], references: [id])
  timetableSlots TimetableSlot[]
  files          File[]
  attendance     Attendance[]

  @@map("subjects")
}

model Room {
  id           String  @id @default(uuid())
  name         String  @unique // e.g., "LH-101"
  building     String
  capacity     Int
  hasProjector Boolean @default(false) @map("has_projector")

  timetableSlots TimetableSlot[]
  events         Event[]

  @@map("rooms")
}

// ============ TIMETABLE ============

model TimetableSlot {
  id        String    @id @default(uuid())
  dayOfWeek DayOfWeek @map("day_of_week")
  startTime String    @map("start_time") // "09:00" (24h format)
  endTime   String    @map("end_time") // "10:00"

  classId   String @map("class_id")
  subjectId String @map("subject_id")
  teacherId String @map("teacher_id")
  roomId    String @map("room_id")

  class   Class   @relation(fields: [classId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])
  teacher Teacher @relation(fields: [teacherId], references: [id])
  room    Room    @relation(fields: [roomId], references: [id])

  @@unique([dayOfWeek, startTime, roomId]) // Room conflict prevention
  @@unique([dayOfWeek, startTime, teacherId]) // Teacher conflict prevention
  @@unique([dayOfWeek, startTime, classId]) // Class conflict prevention
  @@map("timetable_slots")
}

// ============ ATTENDANCE ============

model Attendance {
  id        String   @id @default(uuid())
  date      DateTime @db.Date
  isPresent Boolean  @map("is_present")

  studentId  String @map("student_id")
  subjectId  String @map("subject_id")
  markedById String @map("marked_by_id") // Teacher who marked

  student  Student @relation(fields: [studentId], references: [id])
  subject  Subject @relation(fields: [subjectId], references: [id])
  markedBy Teacher @relation(fields: [markedById], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([date, studentId, subjectId]) // One record per student per subject per day
  @@map("attendance")
}

// ============ EVENTS ============

model Event {
  id            String      @id @default(uuid())
  title         String
  description   String
  startDateTime DateTime    @map("start_date_time")
  endDateTime   DateTime    @map("end_date_time")
  status        EventStatus @default(DRAFT)
  maxCapacity   Int?        @map("max_capacity")

  organizerId String  @map("organizer_id")
  roomId      String? @map("room_id")

  organizer Organizer @relation(fields: [organizerId], references: [id])
  room      Room?     @relation(fields: [roomId], references: [id])

  registrations EventRegistration[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("events")
}

model EventRegistration {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  eventId      String   @map("event_id")
  registeredAt DateTime @default(now()) @map("registered_at")
  attended     Boolean  @default(false)

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("event_registrations")
}

// ============ GRIEVANCE & MAINTENANCE ============

model Grievance {
  id          String       @id @default(uuid())
  title       String
  description String
  status      TicketStatus @default(OPEN)

  submittedById String  @map("submitted_by_id")
  assignedToId  String? @map("assigned_to_id")

  submittedBy User   @relation("SubmittedGrievances", fields: [submittedById], references: [id])
  assignedTo  Admin? @relation("HandledGrievances", fields: [assignedToId], references: [id])

  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  resolvedAt DateTime? @map("resolved_at")

  @@map("grievances")
}

model MaintenanceRequest {
  id          String       @id @default(uuid())
  title       String
  description String
  location    String
  status      TicketStatus @default(OPEN)
  priority    Int          @default(1) // 1-5

  submittedById String @map("submitted_by_id")

  submittedBy User @relation(fields: [submittedById], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("maintenance_requests")
}

// ============ FILES ============

model File {
  id           String @id @default(uuid())
  filename     String
  originalName String @map("original_name")
  mimeType     String @map("mime_type")
  sizeBytes    Int    @map("size_bytes")
  storageKey   String @unique @map("storage_key") // S3 key

  uploadedById String  @map("uploaded_by_id")
  subjectId    String? @map("subject_id") // If linked to a subject

  uploadedBy Teacher  @relation(fields: [uploadedById], references: [id])
  subject    Subject? @relation(fields: [subjectId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("files")
}

// ============ NOTIFICATIONS ============

model Notification {
  id      String           @id @default(uuid())
  title   String
  message String
  type    NotificationType
  isRead  Boolean          @default(false) @map("is_read")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("notifications")
}
